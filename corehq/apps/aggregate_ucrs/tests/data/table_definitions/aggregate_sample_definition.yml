domain: ucr-aggregation-domain
table_id: monthy_aggregate_pregnancies
display_name: Pregnancy Data Per Month
primary_table:
  data_source_id: 550c3cd432d931387e75e8506b5caf9e  # the data source ID of e.g. the 'pregnancy_cases' table
  key_column: doc_id
  columns:
    # this should generate SQL that looks something like:
    # insert into pregnancy_cases... values... (
    #   select name as name, lmp as pregnancy_start_date, 1 as open_in_month,
    #   lmp < :month_end and (delivery_date is null or delivery_date >= :month_start) as pregnant_in_month
    # )
    - column_id: name
      type: reference
      config_params:
        referenced_column: name
    - column_id: pregnancy_start_date
      type: reference
      config_params:
        referenced_column: lmp
    - column_id: open_in_month
      type: constant
      config_params:
        constant: 1
    - column_id: pregnant_in_month
      type: sql_statement
      config_params:
        # sql statements will only be able to access the current row
        statement: lmp < :month_end and (delivery_date is null or delivery_date >= :month_start)
        statement_params:
          # these '_agg' things are magic variables that let you reference the aggregation window's start/end conditions
          month_start: :_agg_window_start
          month_end: :_agg_window_end
aggregation_config:
  unit: month  # unit additionally determines the datatype and the column name used
  # conditions for inclusion of a particular row on a particular month
  # start and end conditions must (currently) be based off the primary data source table
  start_column: date_opened  # if value is not set, defaults to excluding the row entirely
  end_column: date_closed  # if value is not set, defaults to excluding the row beyond the current date
secondary_tables:
  # this is a list, though in this example there is only one.
  - data_source_id: d824a4864ecb421fb3be8bf8173a05d7
    key_column: case_id  # how rows will get joined from primary to secondary tables
    aggregation_column: received_on  # determines the aggregation window that each secondary row falls in
    columns:
      - column_id: fu_forms_in_month
        aggregation_type: sum
        config_params:
          referenced_column: count  # in ucr "count" is an auto-created column that has a 1 in every row
